<?xml version="1.0" encoding="UTF-8"?>

<project name="site" basedir="." xmlns:artifact="urn:maven-artifact-ant">

  <!--global references to other modules-->
  <property name="lib.dir" value="${basedir}/lib"/>
  <property name="static.docs.dir" value="${basedir}/documentation"/>
  <property name="docs.dir" value="${basedir}/target/docs"/>
  <property name="docs.resources.dir" value="${docs.dir}/resources"/>
  <property name="javadoc.dir" value="${docs.dir}/api"/>
  <property name="module.docs.dir" value="${docs.dir}"/>
  <property name="getting.started.example.dir" value="${docs.dir}/wannabecool"/>

  <target name="clean">
    <delete dir="${docs.dir}"/>
  </target>

  <target name="init">
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant" loaderref="antlib.loader">
      <classpath>
        <fileset dir="${lib.dir}/build">
          <include name="maven-ant-tasks-*.jar"/>
        </fileset>
      </classpath>
    </typedef>

    <artifact:pom id="parent.pom" file="pom.xml"/>
    <echo message="Current version is: ${parent.pom.version}"/>
    <property name="dist.name" value="enunciate-${parent.pom.version}"/>
    <property name="full.jar.name" value="enunciate-full-${parent.pom.version}.jar"/>
    <property name="full.sources.jar.name" value="enunciate-full-${version}-sources.jar"/>

    <artifact:dependencies filesetId="dist.libs.fileset" pathId="dist.libs.path">
      <dependency groupId="org.codehaus.enunciate" artifactId="top" version="${parent.pom.version}"/>
    </artifact:dependencies>

    <loadfile srcfile="${static.docs.dir}/topnav.include.html" property="topnav"/>
    <loadfile srcfile="${static.docs.dir}/sidenav.include.html" property="sidenav"/>

    <filterset id="nav.filterset">
      <filter token="TOPNAV" value="${topnav}"/>
      <filter token="SIDENAV" value="${sidenav}"/>
    </filterset>
  </target>

  <target name="copy-static-docs" depends="init, docs-resources-copy">

    <echo>Copying XSD files to ${docs.resources.dir}...</echo>
    <mkdir dir="${docs.resources.dir}"/>
    <copy todir="${docs.resources.dir}">
      <fileset dir="core/src">
        <include name="**/*.xsd"/>
      </fileset>
      <mapper type="flatten"/>
    </copy>

    <echo>Copying static HTML files to ${docs.dir}...</echo>
    <mkdir dir="${docs.dir}"/>
    <copy todir="${docs.dir}" overwrite="true">
      <!--first copy all the html docs.-->
      <fileset dir="${static.docs.dir}">
        <include name="**/*.html"/>
        <exclude name="**/*.include.html"/>
      </fileset>
      <filterset refid="nav.filterset"/>
    </copy>

    <echo>Copying static non-HTML files to ${docs.dir}...</echo>
    <copy todir="${docs.dir}" overwrite="true">
      <!--now copy all the non-html docs except the freemarker templates.-->
      <fileset dir="${static.docs.dir}">
        <exclude name="**/*.html"/>
        <exclude name="**/*.fmt"/>
      </fileset>
    </copy>

    <echo>Copying the license file to ${enunciate.basedir}/license.txt...</echo>
    <copy todir="${docs.dir}" overwrite="true" file="${enunciate.basedir}/license.txt"/>
  </target>

  <target name="javadoc" depends="build">
    <mkdir dir="${javadoc.dir}"/>
    <echo>Building the Javadocs to ${javadoc.dir}...</echo>
    <property name="title" value="enunciate-docs"/>

    <javadoc doctitle="enunciate" windowtitle="enunciate" destdir="${javadoc.dir}" author="true" version="true" packagenames="*">
      <fileset dir="${enunciate.basedir}">
        <include name="**/src/main/java/*.java"/>
      </fileset>

      <classpath>
        <path refid="dist.libs.path"/>
        <pathelement location="${java.home}/../lib/tools.jar"/>
        <path path="${java.class.path}"/>
      </classpath>

      <link href="http://java.sun.com/j2se/1.5.0/docs/api" offline="true" packagelistloc="${enunciate.basedir}/src/javadoc/sdk"/>
      <link href="http://apt-jelly.sourceforge.net/api" offline="true" packagelistloc="${enunciate.basedir}/src/javadoc/apt-jelly"/>
      <link href="http://jakarta.apache.org/commons/digester/commons-digester-1.7/docs/api" offline="true" packagelistloc="${enunciate.basedir}/src/javadoc/commons-digester"/>
      <link href="http://static.springframework.org/spring/docs/1.2.x/api" offline="true" packagelistloc="${enunciate.basedir}/src/javadoc/spring"/>
      <link href="http://envoisolutions.com/xfire/api" offline="true" packagelistloc="${enunciate.basedir}/src/javadoc/xfire"/>
    </javadoc>
  </target>

  <target name="copy-module-docs" depends="init" description="copies over the module documentation to the right place.">
    <echo>Copying the module docs to ${module.docs.dir}...</echo>
    <mkdir dir="${module.docs.dir}"/>
    <copy todir="${module.docs.dir}" overwrite="true">
      <fileset dir="${basedir}">
        <include name="**/target/module-docs/*"/>
      </fileset>
      <filterset refid="nav.filterset"/>
      <mapper type="flatten"/>
    </copy>

    <mkdir dir="${module.docs.dir}/doc-files"/>
    <copy todir="${module.docs.dir}/doc-files">
      <fileset dir="modules">
        <include name="**/doc-files/*"/>
      </fileset>
      <mapper type="flatten"/>
    </copy>
  </target>

  <target name="copy-getting-started-source">
    <taskdef name="java2html" classname="de.java2html.anttasks.Java2HtmlTask">
      <classpath>
        <fileset dir="${lib.dir}/build">
          <include name="**/java2html*.jar"/>
        </fileset>
      </classpath>
    </taskdef>

    <mkdir dir="${getting.started.example.dir}/java_step1"/>
    <java2html srcdir="src/samples/wannabecool/step1" destdir="${getting.started.example.dir}/java_step1" includes="**/*.java"/>
    <copy todir="${getting.started.example.dir}/java_step1" overwrite="true">
      <fileset dir="src/samples/wannabecool/step1/">
        <exclude name="**/*.java"/>
      </fileset>
    </copy>

    <mkdir dir="${getting.started.example.dir}/java_step4"/>
    <java2html srcdir="src/samples/wannabecool/step4" destdir="${getting.started.example.dir}/java_step4" includes="**/*.java"/>
    <copy todir="${getting.started.example.dir}/java_step4" overwrite="true">
      <fileset dir="src/samples/wannabecool/step4/">
        <exclude name="**/*.java"/>
      </fileset>
    </copy>
  </target>

  <target name="getting-started-examples" depends="copy-getting-started-source" description="Generated the getting started examples.">
    <taskdef name="enunciate" classname="org.codehaus.enunciate.main.EnunciateTask">
      <classpath refid="dist.libs.path"/>
    </taskdef>

    <mkdir dir="${getting.started.example.dir}/step1"/>
    <echo message="Generating the step1 examples...."/>
    <enunciate target="build" basedir="src/samples/wannabecool/step1">
      <include name="**/*.java"/>
      <classpath refid="dist.libs.path"/>
      <export artifactId="docs" destination="${getting.started.example.dir}/step1"/>
    </enunciate>

    <mkdir dir="${getting.started.example.dir}/step4"/>
    <echo message="Generating the step4 examples...."/>
    <copy file="src/samples/wannabecool/step4/LICENSE.txt" todir="${user.dir}" overwrite="true"/>
    <enunciate target="build" basedir="src/samples/wannabecool/step4" configFile="src/samples/wannabecool/step4/enunciate.xml">
      <include name="**/*.java"/>
      <classpath refid="dist.libs.path"/>
      <export artifactId="docs" destination="${getting.started.example.dir}/step4"/>
    </enunciate>
    <delete file="${user.dir}/LICENSE.txt" failonerror="false"/>
  </target>

  <target name="doc" description="generate documentation and javadoc (global)" depends="copy-static-docs, javadoc, getting-started-examples, copy-module-docs"/>

  <target name="full-jar" depends="build, full-jar-only" description="Creates the full (aggregated) jar."/>
  <target name="full-jar-only" description="Creates the full jar assuming everything in its place.">
    <mkdir dir="target"/>

    <concat destfile="target/module.list" fixlastline="yes">
      <fileset dir="${enunciate.basedir}" includes="**/org.codehaus.enunciate.modules.DeploymentModule"/>
    </concat>

    <echo file="target/preserve-in-war" message="This file is used simply to mark the enunciate-full jar as a jar to be preserved when building the war."/>

    <jar destfile="target/${full.jar.name}" duplicate="preserve">
      <!--first include the concatenated deployment module list.-->
      <zipfileset dir="target" includes="module.list" fullpath="META-INF/services/org.codehaus.enunciate.modules.DeploymentModule"/>
      <!--make sure the jar is marked to preserve in a war file.-->
      <zipfileset dir="target" includes="preserve-in-war" fullpath="META-INF/enunciate/preserve-in-war"/>

      <zipgroupfileset dir="${enunciate.basedir}">
        <include name="core/target/*.jar"/>
        <include name="modules/*/target/*.jar"/>
        <exclude name="modules/test-integration/target/*.jar"/>
        <exclude name="modules/xfire-integration/target/*.jar"/>
        <exclude name="**/*-sources.jar"/>
      </zipgroupfileset>

    </jar>

    <jar destfile="target/${full.sources.jar.name}" duplicate="preserve">
      <zipgroupfileset dir="${enunciate.basedir}">
        <include name="core/target/*-sources.jar"/>
        <include name="modules/*/target/*-sources.jar"/>
        <exclude name="modules/test-integration/target/*-sources.jar"/>
        <exclude name="modules/xfire-integration/target/*-sources.jar"/>
      </zipgroupfileset>
    </jar>

  </target>

  <target name="install" depends="full-jar">
    <mkdir dir="target/top-jar"/>
    <echo file="target/top-jar/README.txt">
Empty jar for the sole purpose of consolidating the reference to all known Enunciate
jars for the purposes of Maven integration.
    </echo>
    <jar destfile="target/${top.jar.name}">
      <fileset dir="target/top-jar"/>
    </jar>

    <mkdir dir="target/rt-jar"/>
    <echo file="target/rt-jar/README.txt">
Empty jar for the sole purpose of consolidating the reference to all known Enunciate
jars for the purposes of Maven integration.
    </echo>
    <jar destfile="target/${rt.jar.name}">
      <fileset dir="target/rt-jar"/>
    </jar>

    <artifact:install file="target/${top.jar.name}">
      <pom refid="top.pom"/>
    </artifact:install>

    <artifact:install file="target/${rt.jar.name}">
      <pom refid="rt.pom"/>
    </artifact:install>

    <artifact:install file="target/${full.jar.name}">
      <pom refid="full.pom"/>
      <attach file="target/${full.sources.jar.name}" classifier="sources"/>
    </artifact:install>
  </target>

  <target name="dist" depends="clean, install, doc, scripts, dist-only" description="Creates the distribution bundles."/>

  <target name="copy-dist-libs" depends="build">
    <mkdir dir="target/lib"/>
    <mkdir dir="target/module-libs"/>

    <!--load the maven tasks for handling dependencies-->
    <copy todir="target/lib">
      <fileset refid="dist.libs.fileset"/>
      <mapper type="flatten"/>
    </copy>

    <move todir="target/module-libs">
      <fileset dir="target/lib">
        <include name="enunciate-*"/>
      </fileset>
    </move>
  </target>

  <target name="scripts" depends="copy-dist-libs" description="Generates the executable scripts.">

    <path id="script.classpath">
      <fileset dir="target">
        <include name="lib/*.jar"/>
      </fileset>
    </path>

    <pathconvert property="unix.script.classpath" targetos="unix" refid="script.classpath">
      <mapper type="regexp" from="/(lib/.*.jar)$$" to="$ENUNCIATE_HOME/\1"/>
    </pathconvert>
    <pathconvert property="windows.script.classpath" targetos="windows" refid="script.classpath">
      <mapper type="regexp" from="/(lib/.*.jar)$$" to="%ENUNCIATE_HOME%\\\1"/>
    </pathconvert>

    <mkdir dir="target/bin"/>
    <copy file="src/bin/enunciate.sh" tofile="target/bin/enunciate" overwrite="true">
      <filterset begintoken="{" endtoken="}">
        <filter token="UNIX_CLASSPATH" value="${unix.script.classpath}"/>
        <filter token="FULL_JAR_NAME" value="${full.jar.name}"/>
      </filterset>
    </copy>
    <chmod perm="766" file="target/bin/enunciate"/>

    <copy file="src/bin/enunciate.bat" tofile="target/bin/enunciate.bat" overwrite="true">
      <filterset begintoken="{" endtoken="}">
        <filter token="WINDOWS_CLASSPATH" value="${windows.script.classpath}"/>
        <filter token="FULL_JAR_NAME" value="${full.jar.name}"/>
      </filterset>
    </copy>

  </target>

  <target name="dist-only" depends="copy-dist-libs" description="Creates the distribution bundles assuming everything is in its place.">
    <!--create the zip dist.-->
    <zip destfile="target/${dist.name}.zip">
      <zipfileset dir="${docs.dir}" prefix="${dist.name}/docs" excludes="*.txt"/>
      <zipfileset dir="${enunciate.basedir}" prefix="${dist.name}/docs" includes="license.txt notice.txt"/>
      <zipfileset dir="target/bin" prefix="${dist.name}/bin"/>
      <zipfileset dir="target/lib" prefix="${dist.name}/lib"/>
      <zipfileset dir="target/module-libs" prefix="${dist.name}/modules" includes="*.jar"/>
      <zipfileset dir="." includes="license.txt notice.txt" prefix="${dist.name}"/>
      <zipfileset dir="target" prefix="${dist.name}" includes="*.jar"/>
      <zipfileset dir="src/samples/wannabecool/step4" prefix="${dist.name}/samples/wannabecool/src/main/java"/>
      <zipfileset dir="src/samples/wannabecool/build" prefix="${dist.name}/samples/wannabecool"/>
      <zipfileset dir="src/samples/petclinic" prefix="${dist.name}/samples/petclinic"/>
      <zipfileset dir="src/samples/addressbook" prefix="${dist.name}/samples/addressbook"/>
    </zip>

    <!--create the tar.gz dist.-->
    <tar destfile="target/${dist.name}.tar.gz" compression="gzip">
      <tarfileset dir="${docs.dir}" prefix="${dist.name}/docs" excludes="*.txt"/>
      <tarfileset dir="${enunciate.basedir}" prefix="${dist.name}/docs" includes="license.txt notice.txt"/>
      <tarfileset dir="target/bin" prefix="${dist.name}/bin" mode="766"/>
      <tarfileset dir="target/lib" prefix="${dist.name}/lib"/>
      <tarfileset dir="target/module-libs" prefix="${dist.name}/modules" includes="*.jar"/>
      <tarfileset dir="." includes="license.txt notice.txt" prefix="${dist.name}"/>
      <tarfileset dir="target" prefix="${dist.name}" includes="*.jar"/>
      <tarfileset dir="src/samples/wannabecool/step4" prefix="${dist.name}/samples/wannabecool/src/main/java"/>
      <tarfileset dir="src/samples/wannabecool/build" prefix="${dist.name}/samples/wannabecool"/>
      <tarfileset dir="src/samples/petclinic" prefix="${dist.name}/samples/petclinic"/>
      <tarfileset dir="src/samples/addressbook" prefix="${dist.name}/samples/addressbook"/>
    </tar>
  </target>

  <target name="src-dist" description="Packages up the sources.">

    <mkdir dir="target/src"/>
    <copy todir="target/src">
      <fileset dir="${enunciate.basedir}">
        <include name="core/src/java/**/*"/>
        <include name="modules/*/src/java/**/*"/>
      </fileset>

      <mapper type="regexp" from=".*/src/java/(.*)" to="\1"/>
    </copy>

    <copy todir="target/src">
      <fileset dir="${enunciate.basedir}">
        <include name="core/src/tools/**/*"/>
        <include name="modules/*/src/tools/**/*"/>
      </fileset>

      <mapper type="regexp" from=".*/src/tools/(.*)" to="\1"/>
    </copy>

    <!--create the zip dist.-->
    <zip destfile="target/${dist.name}-src.zip">
      <zipfileset dir="target/src" prefix="${dist.name}/src">
        <include name="**/*"/>
      </zipfileset>
    </zip>

    <!--create the tar.gz dist.-->
    <tar destfile="target/${dist.name}-src.tar.gz" compression="gzip">
      <tarfileset dir="target/src" prefix="${dist.name}/src">
        <include name="**/*"/>
      </tarfileset>
    </tar>
  </target>

</project>
